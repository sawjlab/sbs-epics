#
#
#
record(stringout, "$(CrName)$(Cr):$(Sl):$(Ch):Name") 
{
   field(DESC,"$(CrName)$(Cr):$(Sl):$(Ch)")
}

record(stringout, "$(CrName)$(Cr):$(Sl):$(Ch):Alias") 
{
   field(DESC, "BB_DET_$(Det)_$(Sys)_$(Element)")
}


record(bigsub, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub") 
{
   field(PRIO,"LOW")
   field(DESC,"$(Det)_HV_$(Element)")
   field(INAM,"InitChannel")
   field(INPA,"$(Cr)")
   field(INPB,"$(Sl)")
   field(INPC,"$(Ch)")
field(LSV,"MINOR")
field(HSV,"MINOR")
field(LLSV,"MAJOR")
field(HHSV,"MAJOR")
field(HIGH,"10")
field(LOW,"-10")
field(HIHI, "10000")
field(LOLO,"-10000")
   field(PREC,"1")
   field(SNAM,"ScanChannel")
   field(SCAN,"2 second")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element)")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element)")
info(autosaveFields_pass0,"HSV LSV HIGH LOW DESC")
}

#Alias records for the bigsub
#Crate
record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):Crate")
{
   field(DTYP, "Soft Channel")
   field(DESC,"Crate Number")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.A CPP")
   field(SCAN, "Passive")
   field(PREC,"0")
}   
record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):Slot")
{
   field(DTYP, "Soft Channel")
   field(DESC,"Slot Number")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.B CPP")
   field(SCAN, "Passive")
   field(PREC,"0")
}   
record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):Chan")
{
   field(DTYP, "Soft Channel")
   field(DESC,"Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.C CPP")
   field(SCAN, "Passive")
   field(PREC,"0")
}   
# Current
record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):IMon")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.E CPP")
   field(SCAN, "Passive")
   field(EGU, "uA")
   info(autosaveFields_pass0,"HSV LSV HHSV LLSV HIGH LOW HIHI LOLO")
}   

# Measured voltage
record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):VMon")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.F CPP")
   field(SCAN, "Passive")
   field(EGU, "V")
   field(PREC,"2")
   field(FLNK, "$(CrName)$(Cr):$(Sl):$(Ch):VDiff")
}

record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):V0Setr")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.G CPP")
   field(SCAN, "Passive")
   field(PREC,"2")
   field(EGU,"V")
   field(FLNK, "$(CrName)$(Cr):$(Sl):$(Ch):VDiff")
}   

record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):RUpr")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.H CPP")
   field(SCAN, "Passive")
   field(PREC,"2")
   field(EGU,"V/s")
}   

record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):RDWnr")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.I CPP")
   field(SCAN, "Passive")
   field(PREC,"2")
   field(EGU,"V/s")
}   
record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):I0Setr")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.J CPP")
   field(SCAN, "Passive")
   field(PREC,"2")
   field(EGU,"uA")
}   
record(bi, "$(CrName)$(Cr):$(Sl):$(Ch):Pwr")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub:.K CPP")
   field(SCAN, "Passive")
   field(ZNAM,"OFF")
   field(ONAM,"ON")
}

record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):Status")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.L CPP NMS")
   field(SCAN, "Passive")
   field(PREC,"2")
}   
record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):SVMaxr")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.O CPP")
   field(SCAN, "Passive")
   field(PREC,"2")
   field(EGU,"V")
}   
record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):triprbk")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.P CPP")
   field(SCAN, "Passive")
   field(PREC,"2")
   field(EGU,"s")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):triprbk")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):triprbk")
}   

record(bi, "$(CrName)$(Cr):$(Sl):$(Ch):rangerbk")
{
   field(DTYP, "Soft Channel")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch):bigsub.S CPP NMS")
   field(SCAN, "Passive")
   field(ZNAM,"High")
   field(ONAM,"Low")
}   

record(ai, "$(CrName)$(Cr):$(Sl):$(Ch):comms")
{
   field(DESC,"#GR")
   field(INP, "$(CrName)$(Cr):$(Sl):$(Ch)bigsub.T CPP NMS")
   field(SCAN, "Passive")
   field(PREC,"2")
}   

record(bo, "$(CrName)$(Cr):$(Sl):$(Ch):Pw") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#PB")
   field(OUT,"$(CScode) $(pwonoff)")
   field(OMSL,"supervisory")
   field(ZNAM,"OFF")
   field(ONAM,"ON")
   field(SCAN,"Passive")
}
record(bo, "$(CrName)$(Cr):$(Sl):$(Ch):Enable") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#PB")
   field(OUT,"$(CScode) $(enable)")
   field(OMSL,"supervisory")
   field(ZNAM,"DISABLED")
   field(ONAM,"ENABLED")
   field(SCAN,"Passive")
}

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):V0Set") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#GR")
   field(OUT,"$(CScode) $(v0set)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"V")
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):I0Set") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#GR")
   field(OUT,"$(CScode) $(i0set)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"uA")
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):Trip") 
{
   field(DTYP,"CAEN_HV")
   field(OUT,"$(CScode) $(trip)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"s")
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):RUp") {
   field(DTYP,"CAEN_HV")
   field(DESC,"#PD")
   field(OUT,"$(CScode) $(rampup)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"V/s")
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):RDWn") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#PD")
   field(OUT,"$(CScode) $(rampdn)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"V/s")
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):SVmax") 
{
   field(DTYP,"CAEN_HV")
   field(OUT,"$(CScode) $(svmax)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"V")
}

# this record is unique to dual-range boards (e.g. 1536HD)
# signal S0 for CAEN_HV records is disabled.
#
record(bo, "$(CrName)$(Cr):$(Sl):$(Ch):range") 
{
   field(DTYP,"CAEN_HV")
   field(OUT,"$(CScode) S$(range=0)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(ZNAM,"High")
   field(ONAM,"Low")
   field(DISV,"0")
   field(DISA,"$(range=0)")
}

record(ai,"$(CrName)$(Cr):$(Sl):$(Ch):type")
{
   field(VAL,"$(CrType)")
}


# :hwstatmaxbitcalc
#
# This record just picks out the most significant non-zero bit
# of the :Status hardware status.  This is appropriate since CAEN
# ordered their SYX527 status bits such that most significant bit
# is the most significant status (error).
#
# Note, CAEN leaves bit 12 unused.  If we do the same, we run out
# of mbbi bits (16).  So, if :Status>=2^12, downshift by one bit.
#
record(calc,"$(CrName)$(Cr):$(Sl):$(Ch):hwstatmaxbitcalc")
{
    field(INPA, "$(CrName)$(Cr):$(Sl):$(Ch):Status CPP")
    field(CALC,"A=0 ? 0 : floor(log(A)/log(2))+1-(A<8192?0:1)")
#    alias("BB_DET_$(Det)_$(Sys)_$(Element):hwstatmaxbitcalc")
}

# :hwstatmaxbit
#
# This record just provides a mapping from CAEN status bits to
# their corresponding string values and severities, using only
# the most significant bit from statmaxbitcalc.  Note the shift
# explained above for stat>=2^12.
record(mbbi,"$(CrName)$(Cr):$(Sl):$(Ch):hwstatmaxbit")
{
    field(INP,"$(CrName)$(Cr):$(Sl):$(Ch):hwstatmaxbitcalc CPP")
    field(ZRVL,"0")
    field(ONVL,"1")
    field(TWVL,"2")
    field(THVL,"3")
    field(FRVL,"4")
    field(FVVL,"5")
    field(SXVL,"6")
    field(SVVL,"7")
    field(EIVL,"8")
    field(NIVL,"9")
    field(TEVL,"10")
    field(ELVL,"11")
    field(TVVL,"12")
    field(TTVL,"13")
    field(FTVL,"14")
    field(FFVL,"15")
    field(ZRST,"OFF")
    field(ONST,"ON")
    field(TWST,"RUP")
    field(THST,"RDN")
    field(FRST,"OVC")
    field(FVST,"OVV")
    field(SXST,"UNV")
    field(SVST,"ExTrip")
    field(EIST,"MAXV")
    field(NIST,"ExDis")
    field(TEST,"InTrip")
    field(ELST,"Calib")
    field(TVST,"ChUnplug")
    field(TTST,"OVP")
    field(FTST,"PwFail")
    field(FFST,"TempErr")
    field(ZRSV,"NO_ALARM")
    field(ONSV,"NO_ALARM")
    field(TWSV,"MINOR")
    field(THSV,"MINOR")
    field(FRSV,"MAJOR")
    field(FVSV,"MAJOR")
    field(SXSV,"MAJOR")
    field(SVSV,"MAJOR")
    field(EISV,"MAJOR")
    field(NISV,"MAJOR")
    field(TESV,"MAJOR")
    field(ELSV,"MAJOR")
    field(TVSV,"MAJOR")
    field(TTSV,"MAJOR")
    field(FTSV,"MAJOR")
    field(FFSV,"MAJOR")
#    alias("BB_DET_$(Det)_$(Sys)_$(Element):hwstatmaxbit")   
}

# This is the final status summary record.  Precendence order is:
# 1. Communications error
# 2. Hardware errors
# 3. Mismatch between measured/demand on/off 
# 4. Mismatch measured/demand voltage
#record(calc,"$(CrName)$(Cr):$(Sl):$(Ch):statcalc")
#{
#    field(INPA,"$(CrName)$(Cr):$(Sl):$(Ch):comms CPP")
#    field(INPB,"$(CrName)$(Cr):$(Sl):$(Ch):statmaxbit CPP")
#    field(INPC,"$(CrName)$(Cr):$(Sl):$(Ch):VMon CPP")
#    field(INPD,"$(CrName)$(Cr):$(Sl):$(Ch):V0Setr CPP")
#    field(INPE,"$(CrName)$(Cr):$(Sl):$(Ch):Status CPP")
#    field(INPF,"$(CrName)$(Cr):$(Sl):$(Ch):Pwr CPP")
#    field(HIHI,9999)
#    field(HIGH,10)
#    field(LOW,-10)
#    field(LOLO,-9999)
#    alias("BB_DET_$(Det)_$(Sys)_$(Element):statcalc")   
#}

#
# Record for alarms
#
record(calc, "$(CrName)$(Cr):$(Sl):$(Ch):VDiff")
{
    field(DESC, "Alarm Record: Voltage Difference")
    field(INPA, "$(CrName)$(Cr):$(Sl):$(Ch):VMon")
    field(INPB, "$(CrName)$(Cr):$(Sl):$(Ch):V0Setr")
    field(CALC, "(A-B)")
    field(PREC, "1")
    field(SCAN, "Passive")
    field(LOLO, "$(lolo)")
    field(LOW, "$(low)")
    field(HIGH, "$(high)")
    field(HIHI, "$(hihi)")
    field(LLSV, "MAJOR")
    field(LSV, "MINOR")
    field(HSV, "MINOR")
    field(HHSV, "MAJOR")
    field(EGU, "V")
}
