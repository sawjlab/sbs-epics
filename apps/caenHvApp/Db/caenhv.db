#
#
#
record(stringout, "$(CrName)$(Cr):$(Sl):$(Ch):Name") 
{
   field(DESC,"$(CrName)$(Cr):$(Sl):$(Ch)")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):Name")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):Name")
}

record(stringout, "$(CrName)$(Cr):$(Sl):$(Ch):Alias") 
{
   field(DESC, "BB_DET_$(Det)_$(Sys)_$(Element)")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):Alias")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):Alias")
}


record(bigsub, "$(CrName)$(Cr):$(Sl):$(Ch)") 
{
   field(PRIO,"LOW")
   field(DESC,"$(Det)_HV_$(Element)")
   field(INAM,"InitChannel")
   field(INPA,"$(Cr)")
   field(INPB,"$(Sl)")
   field(INPC,"$(Ch)")
field(LSV,"MINOR")
field(HSV,"MINOR")
field(LLSV,"MAJOR")
field(HHSV,"MAJOR")
field(HIGH,"10")
field(LOW,"-10")
field(HIHI, "10000")
field(LOLO,"-10000")
   field(PREC,"1")
   field(SNAM,"ScanChannel")
   field(SCAN,"2 second")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element)")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element)")
info(autosaveFields_pass0,"HSV LSV HIGH LOW DESC")
}


record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):Crate")
{
   field(DESC,"Crate Number")
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).A CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"0")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):crate")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):crate")
}   
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):Slot")
{
   field(DESC,"Slot Number")
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).B CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"0")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):slot")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):slot")
}   
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):Chan")
{
   field(DESC,"Channel Number")
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).C CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"0")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):chan")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):chan")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):VMon")
{
   field(DESC,"#GR")
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).F CPP NMS")
   field(OMSL,"closed_loop")
   field(EGU,"V")
   field(PREC,"2")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):VMon")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):VMon")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):IMon")
{
   field(DESC,"#GR")
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).E CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
   field(EGU,"uA")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):IMon")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):IMon")
   info(autosaveFields_pass0,"HSV LSV HHSV LLSV HIGH LOW HIHI LOLO")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):triprbk")
{
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).P CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
   field(EGU,"s")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):triprbk")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):triprbk")
}   
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):V0Setr")
{
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).G CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
   field(EGU,"V")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):V0Setr")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):V0Setr")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):I0Setr")
{
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).J CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
   field(EGU,"uA")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):I0Setr")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):I0Setr")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):SVMaxr")
{
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).O CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
   field(EGU,"V")
 #  alias("BB_DET_$(Det)_$(Sys)_$(Element):SVMaxr")
 #  alias("BB_SYS_$(Sys)_$(Det)_$(Element):SVMaxr")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):RUpr")
{
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).H CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
   field(EGU,"V/s")
 #  alias("BB_DET_$(Det)_$(Sys)_$(Element):RUpr")
 #  alias("BB_SYS_$(Sys)_$(Det)_$(Element):RUpr")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):RDWnr")
{
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).I CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
   field(EGU,"V/s")
 #  alias("BB_DET_$(Det)_$(Sys)_$(Element):RDWnr")
 #  alias("BB_SYS_$(Sys)_$(Det)_$(Element):RDWnr")
}   
record(bo, "$(CrName)$(Cr):$(Sl):$(Ch):rangerbk")
{
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).S CPP NMS")
   field(OMSL,"closed_loop")
   field(ZNAM,"High")
   field(ONAM,"Low")
 #  alias("BB_DET_$(Det)_$(Sys)_$(Element):rangerbk")
 #  alias("BB_SYS_$(Sys)_$(Det)_$(Element):rangerbk")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):Status")
{
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).L CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
 #  alias("BB_DET_$(Det)_$(Sys)_$(Element):Status")
 #  alias("BB_SYS_$(Sys)_$(Det)_$(Element):Status")
}   

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):comms")
{
   field(DESC,"#GR")
   field(DOL, "$(CrName)$(Cr):$(Sl):$(Ch).T CPP NMS")
   field(OMSL,"closed_loop")
   field(PREC,"2")
 #  alias("BB_DET_$(Det)_$(Sys)_$(Element):comms")
 #  alias("BB_SYS_$(Sys)_$(Det)_$(Element):comms")
}   

record(bo, "$(CrName)$(Cr):$(Sl):$(Ch):Pwr") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#PB")
   field(OUT,"$(CScode) $(pwonoff)")
   field(OMSL,"supervisory")
   field(ZNAM,"OFF")
   field(ONAM,"ON")
   field(SCAN,"Passive")
   alias("$(CrName)$(Cr):$(Sl):$(Ch):Pw") 
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):Pwr")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):Pwr")
}
record(bo, "$(CrName)$(Cr):$(Sl):$(Ch):Enable") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#PB")
   field(OUT,"$(CScode) $(enable)")
   field(OMSL,"supervisory")
   field(ZNAM,"DISABLED")
   field(ONAM,"ENABLED")
   field(SCAN,"Passive")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):enable")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):enable")
}

record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):V0Set") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#GR")
   field(OUT,"$(CScode) $(v0set)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"V")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):V0Set")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):V0Set")
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):I0Set") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#GR")
   field(OUT,"$(CScode) $(i0set)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"uA")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):I0Set")
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):I0Set")
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):Trip") 
{
   field(DTYP,"CAEN_HV")
   field(OUT,"$(CScode) $(trip)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"s")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):trip")   
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):trip")   
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):RUp") {
   field(DTYP,"CAEN_HV")
   field(DESC,"#PD")
   field(OUT,"$(CScode) $(rampup)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"V/s")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):RUp")   
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):RUp")   
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):RDWn") 
{
   field(DTYP,"CAEN_HV")
   field(DESC,"#PD")
   field(OUT,"$(CScode) $(rampdn)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"V/s")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):RDWn")   
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):RDWn")   
}
record(ao, "$(CrName)$(Cr):$(Sl):$(Ch):SVmax") 
{
   field(DTYP,"CAEN_HV")
   field(OUT,"$(CScode) $(svmax)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(EGU,"V")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):SVmax")   
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):SVmax")   
}

# this record is unique to dual-range boards (e.g. 1536HD)
# signal S0 for CAEN_HV records is disabled.
#
record(bo, "$(CrName)$(Cr):$(Sl):$(Ch):range") 
{
   field(DTYP,"CAEN_HV")
   field(OUT,"$(CScode) S$(range=0)")
   field(OMSL,"supervisory")
   field(SCAN,"Passive")
   field(ASG,"EXPERT")
   field(ZNAM,"High")
   field(ONAM,"Low")
   field(DISV,"0")
   field(DISA,"$(range=0)")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):range")   
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):range")   
}

record(ai,"$(CrName)$(Cr):$(Sl):$(Ch):type")
{
   field(VAL,"$(CrType)")
#   alias("BB_DET_$(Det)_$(Sys)_$(Element):type")   
#   alias("BB_SYS_$(Sys)_$(Det)_$(Element):type")   
}


# :hwstatmaxbitcalc
#
# This record just picks out the most significant non-zero bit
# of the :Status hardware status.  This is appropriate since CAEN
# ordered their SYX527 status bits such that most significant bit
# is the most significant status (error).
#
# Note, CAEN leaves bit 12 unused.  If we do the same, we run out
# of mbbi bits (16).  So, if :Status>=2^12, downshift by one bit.
#
record(calc,"$(CrName)$(Cr):$(Sl):$(Ch):hwstatmaxbitcalc")
{
    field(INPA, "$(CrName)$(Cr):$(Sl):$(Ch):Status CPP")
    field(CALC,"A=0 ? 0 : floor(log(A)/log(2))+1-(A<8192?0:1)")
#    alias("BB_DET_$(Det)_$(Sys)_$(Element):hwstatmaxbitcalc")
}

# :hwstatmaxbit
#
# This record just provides a mapping from CAEN status bits to
# their corresponding string values and severities, using only
# the most significant bit from statmaxbitcalc.  Note the shift
# explained above for stat>=2^12.
record(mbbi,"$(CrName)$(Cr):$(Sl):$(Ch):hwstatmaxbit")
{
    field(INP,"$(CrName)$(Cr):$(Sl):$(Ch):hwstatmaxbitcalc CPP")
    field(ZRVL,"0")
    field(ONVL,"1")
    field(TWVL,"2")
    field(THVL,"3")
    field(FRVL,"4")
    field(FVVL,"5")
    field(SXVL,"6")
    field(SVVL,"7")
    field(EIVL,"8")
    field(NIVL,"9")
    field(TEVL,"10")
    field(ELVL,"11")
    field(TVVL,"12")
    field(TTVL,"13")
    field(FTVL,"14")
    field(FFVL,"15")
    field(ZRST,"OFF")
    field(ONST,"ON")
    field(TWST,"RUP")
    field(THST,"RDN")
    field(FRST,"OVC")
    field(FVST,"OVV")
    field(SXST,"UNV")
    field(SVST,"ExTrip")
    field(EIST,"MAXV")
    field(NIST,"ExDis")
    field(TEST,"InTrip")
    field(ELST,"Calib")
    field(TVST,"ChUnplug")
    field(TTST,"OVP")
    field(FTST,"PwFail")
    field(FFST,"TempErr")
    field(ZRSV,"NO_ALARM")
    field(ONSV,"NO_ALARM")
    field(TWSV,"MINOR")
    field(THSV,"MINOR")
    field(FRSV,"MAJOR")
    field(FVSV,"MAJOR")
    field(SXSV,"MAJOR")
    field(SVSV,"MAJOR")
    field(EISV,"MAJOR")
    field(NISV,"MAJOR")
    field(TESV,"MAJOR")
    field(ELSV,"MAJOR")
    field(TVSV,"MAJOR")
    field(TTSV,"MAJOR")
    field(FTSV,"MAJOR")
    field(FFSV,"MAJOR")
#    alias("BB_DET_$(Det)_$(Sys)_$(Element):hwstatmaxbit")   
}

# This is the final status summary record.  Precendence order is:
# 1. Communications error
# 2. Hardware errors
# 3. Mismatch between measured/demand on/off 
# 4. Mismatch measured/demand voltage
#record(calc,"$(CrName)$(Cr):$(Sl):$(Ch):statcalc")
#{
#    field(INPA,"$(CrName)$(Cr):$(Sl):$(Ch):comms CPP")
#    field(INPB,"$(CrName)$(Cr):$(Sl):$(Ch):statmaxbit CPP")
#    field(INPC,"$(CrName)$(Cr):$(Sl):$(Ch):VMon CPP")
#    field(INPD,"$(CrName)$(Cr):$(Sl):$(Ch):V0Setr CPP")
#    field(INPE,"$(CrName)$(Cr):$(Sl):$(Ch):Status CPP")
#    field(INPF,"$(CrName)$(Cr):$(Sl):$(Ch):Pwr CPP")
#    field(HIHI,9999)
#    field(HIGH,10)
#    field(LOW,-10)
#    field(LOLO,-9999)
#    alias("BB_DET_$(Det)_$(Sys)_$(Element):statcalc")   
#}

